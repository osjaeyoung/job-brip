<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mybatis.adminPost">

    <!-- 신고 목록 조회 -->
    <select id="getReportList" parameterType="map" resultType="map">
        SELECT 
            pr.report_id,
            pr.post_id,
            p.category,
            u.nickname as reporter_nickname,
            pr.report_reason,
            pr.status,
            DATE_FORMAT(pr.created_at, '%Y-%m-%d %H:%i') as reported_at,
            DATE_FORMAT(pr.processed_at, '%Y-%m-%d %H:%i') as processed_at
        FROM post_reports pr
        JOIN posts p ON pr.post_id = p.post_id
        JOIN users u ON pr.reporter_id = u.id
        <where>
            <if test="status != null and status != ''">
                AND pr.status = #{status}
            </if>
        </where>
        ORDER BY 
        <choose>
            <when test="sort == 'oldest'">pr.created_at ASC</when>
            <otherwise>pr.created_at DESC</otherwise>
        </choose>
    </select>

    <!-- 신고 상세 조회 -->
    <select id="getReportDetail" parameterType="long" resultType="map">
        SELECT 
            pr.report_id,
            pr.post_id,
            p.category,
            p.content as post_content,
            p.img_url as post_image,
            u1.nickname as reporter_nickname,
            u2.nickname as post_author_nickname,
            pr.report_reason,
            pr.status,
            DATE_FORMAT(pr.created_at, '%Y-%m-%d %H:%i') as reported_at,
            DATE_FORMAT(pr.processed_at, '%Y-%m-%d %H:%i') as processed_at
        FROM post_reports pr
        JOIN posts p ON pr.post_id = p.post_id
        JOIN users u1 ON pr.reporter_id = u1.id
        JOIN users u2 ON p.user_id = u2.id
        WHERE pr.report_id = #{reportId}
    </select>

    <!-- 신고 상태 업데이트 -->
    <update id="updateReportStatus" parameterType="map">
        UPDATE post_reports 
        SET 
            status = #{status},
            processed_at = CURRENT_TIMESTAMP
        WHERE report_id = #{reportId}
    </update>

    <!-- 신고된 게시글 삭제 처리 -->
    <update id="deleteReportedPost" parameterType="long">
        UPDATE posts p
        JOIN post_reports pr ON p.post_id = pr.post_id
        SET p.is_deleted = true
        WHERE pr.report_id = #{reportId}
    </update>

</mapper>